var ctx,
    c,
    token = $("meta[name='_csrf']").attr("content"),
    meses = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
fabric.Object.prototype.objectCaching = !0;
var canvasInscripcion = new fabric.Canvas("mycanvasInscripcion", { renderOnAddRemove: !0, canvasInscripcionOriginalWidth: 800, canvasInscripcionOriginalHeight: 800, canvasInscripcionWidth: 800, canvasInscripcionHeight: 800 });

var path= window.location.pathname;
var imgTarjeta;
var imgLogoUfps;
var offsetQr;
if(path.includes('detalles')){
	imgTarjeta="../img/tarjeta_inscripcion.jpg";
	imgLogoUfps="../logos/logo-ufps-vertical.jpg";
	offsetQr=true;
}else{
	imgTarjeta="img/tarjeta_inscripcion.jpg";
	imgLogoUfps="logos/logo-ufps-vertical.jpg";
	offsetQr=false;
}

function createTemplateCanvasInscripcion() {
    fabric.Image.fromURL(imgTarjeta, function (n) {
        canvasInscripcion.setBackgroundImage(n, canvasInscripcion.renderAll.bind(canvasInscripcion), { scaleX: canvasInscripcion.width / n.width, scaleY: canvasInscripcion.height / n.height });
    }),
        fabric.Image.fromURL(imgLogoUfps, function (n) {
            n.scale(0.065), canvasInscripcion.add(n.set({ left: 50, top: 50 }));
        });
}
function buildOptions() {
    (buttonsJson = {}),
        listTipoPersonaValidInscripcion.forEach(function (n) {
            var i = "btn" + n[1];
            (btnn = {}), (btnn.text = n[1]), (btnn.value = n[0]), (buttonsJson[i] = btnn);
        }),
        swal("Cómo desea realizar la inscripción?", { buttons: buttonsJson }).then((n) => {
            null != n && prepararInscripcion(n);
        });
}
function realizarInscripcion() {
    //listTipoPersonaValidInscripcion.length > 1 ? buildOptions() : prepararInscripcion(listTipoPersonaValidInscripcion[0][0]);
	$("#modalPreinscripcion").modal("show")
}
function showSpinnerInscripcion() {
    (document.getElementById("btnSpinnerInscripcionForm").style.display = "flex"), (document.getElementById("btnInscripcionForm").style.display = "none");
}
function hideSpinnerInscripcion() {
	try {
    	(document.getElementById("btnSpinnerInscripcionForm").style.display = "none"), (document.getElementById("btnInscripcionForm").style.display = "inline");
    } catch (n) {}
}
function prepararInscripcion() {
    showSpinnerInscripcion(), ajaxRealizarInscripcion();
}
function ajaxRealizarInscripcion() {
	var valid1=validateSelect("select_perfil_inscripcion", "errorPerfilInscripcion");
	var valid2= !enableToPay || (enableToPay && validateInputTextRequerido("inputConstanciaPago","errorConstanciaPagoInscripcion"));
	var tipoPersona=document.getElementById("select_perfil_inscripcion").value;
	
	if(!valid1 || !valid2){
		toastr.error("Diligenciar todos los campos requeridos...", "Error!");
		hideSpinnerInscripcion();
		return;
	}
	var e = new FormData();
    e.append("idTipoPersona", tipoPersona);
	e.append("idEduContinua", idEduContinua);
    if(enableToPay){
    	e.append("filePago", $("#inputConstanciaPago")[0].files[0]);
    }
	
    
    $.ajax({
        headers: { "X-CSRF-TOKEN": token },
        type: "POST",
        url: contextPath + "/preinscripcion/realizar-inscripcion",
        data: e,
        enctype: "multipart/form-data",
        processData: !1,
        contentType: !1,
        success: function (n) {
        	creacionTarjetaInscripcion(n);
        },
        error: function (n) {
            hideSpinnerInscripcion();
        },
    });
}
function creacionTarjetaInscripcion(n) {
    var i = n.primerNombre,
        e = n.segundoNombre,
        t = n.primerApellido,
        a = n.segundoApellido,
        c = new Date(n.fechaInicioEduContinua),
        o = offsetQr ? ("../" + n.imagenQr) : n.imagenQr,
        r = "";
    r = null != e ? i + " " + e : i;
    var s = t + " " + a,
        l = null,
        p = null,
        d = (c.getDate() < 10 ? "0" + c.getDate() : c.getDate()) + " " + meses[c.getMonth()] + " " + c.getFullYear();
    (l = c.getHours() < 10 ? "0" + c.getHours() : c.getHours()), (p = c.getMinutes() < 10 ? "0" + c.getMinutes() : c.getMinutes());
    var f = null;
    f = c.getHours() <= 11 ? l + ":" + p + " A.M" : 12 == c.getHours() ? l + ":" + p + " M" : l + ":" + p;
    var u = n.educacionContinua.length > 70 ? 25 : 30,
        I = n.educacionContinua.length > 70 ? 50 : 80,
        g = new fabric.Textbox(n.educacionContinua, { fontSize: u, fontFamily: "Berlin Sans FB", textAlign: "center", fill: "#000", width: 420, fixedWith: 420, left: 300, top: I });
    canvasInscripcion.add(g);
    var h = r.length > 30 ? 350 : 300;
    g = new fabric.Textbox(r, { fontSize: 30, fontFamily: "Berlin Sans FB", textAlign: "left", fill: "#000", width: 350, fixedWith: 350, left: 80, top: 270 });
    canvasInscripcion.add(g);
    g = new fabric.Textbox(s, { fontSize: 30, fontFamily: "Berlin Sans FB", textAlign: "left", fill: "#000", width: 350, fixedWith: 350, left: 80, top: h });
    canvasInscripcion.add(g);
    g = new fabric.Textbox(n.tipoParticipante.toUpperCase(), { fontSize: 35, fontFamily: "Berlin Sans FB", textAlign: "left", fontWeight: "bold", fill: "#000", width: 400, fixedWith: 450, left: 80, top: 440 });
    canvasInscripcion.add(g);
    g = new fabric.Textbox(n.tipoEduContinua.toUpperCase(), { fontSize: 35, fontFamily: "Berlin Sans FB", textAlign: "left", fontWeight: "bold", fill: "#000", width: 250, fixedWith: 250, left: 500, top: 530 });
    canvasInscripcion.add(g);
    g = new fabric.Textbox(n.lugarEducacionContinua, { fontSize: 30, fontFamily: "Berlin Sans FB", textAlign: "left", fill: "#000", width: 700, fixedWith: 700, left: 80, top: 600 });
    canvasInscripcion.add(g);
    g = new fabric.Textbox("Lugar", { fontSize: 27, fontFamily: "Berlin Sans FB", fontStyle: "italic", textAlign: "left", fill: "#818386", width: 100, fixedWith: 150, left: 80, top: 640 });
    canvasInscripcion.add(g);
    g = new fabric.Textbox(d, { fontSize: 30, fontFamily: "Berlin Sans FB", textAlign: "left", fill: "#000", width: 400, fixedWith: 450, left: 80, top: 690 });
    canvasInscripcion.add(g);
    g = new fabric.Textbox("Fecha Inicio", { fontSize: 27, fontFamily: "Berlin Sans FB", fontStyle: "italic", textAlign: "left", fill: "#818386", width: 400, fixedWith: 400, left: 80, top: 720 });
    canvasInscripcion.add(g);
    g = new fabric.Textbox(f, { fontSize: 30, fontFamily: "Berlin Sans FB", textAlign: "left", fill: "#000", width: 400, fixedWith: 450, left: 450, top: 690 });
    canvasInscripcion.add(g);
    g = new fabric.Textbox("Hora Inicio", { fontSize: 27, fontFamily: "Berlin Sans FB", fontStyle: "italic", textAlign: "left", fill: "#818386", width: 400, fixedWith: 400, left: 450, top: 720 });
    canvasInscripcion.add(g),
        fabric.Image.fromURL(o, function (i) {
            canvasInscripcion.add(i.set({ left: 430, top: 220 }));
            var e = canvasInscripcion.toDataURL({ format: "jpg", quality: 0.8 });
            guardarTarjeta(dataURItoBlob(e), n.id), clearCanvas();
        });
}
function guardarTarjeta(n, i) {
    var e = new FormData(),
        t = new File([n], "tarjeta.jpg", { type: "image/jpg" });
    e.append("file", t),
        e.append("idParticipante", i),
        $.ajax({
            headers: { "X-CSRF-TOKEN": token },
            url: contextPath + "/preinscripcion/generar-tarjeta-inscripcion",
            type: "POST",
            data: e,
            enctype: "multipart/form-data",
            processData: !1,
            contentType: !1,
            cache: !1,
            success: function (n) {
                var i = document.getElementById("btn_inscripcion");
                null != i
                    ? (toastr.success("Se ha realizado la inscripción con éxito", "Excelente!"), $("#modalPreinscripcion").modal("hide"), (i.innerHTML = "CANCELAR INSCRIPCIÓN!"), i.setAttribute("onclick", "cancelarInscripcion()"), hideSpinnerInscripcion())
                    : reloadListPonentes(),
                    loadCantidadInscritos();
            },
            error: function (n) {
                console.error(n);
            },
        });
}
function cancelarInscripcion() {
    showSpinnerInscripcion(), ajaxCancelarInscripcion();
}
function ajaxCancelarInscripcion() {
    $.ajax({
        headers: { "X-CSRF-TOKEN": token },
        type: "GET",
        contentType: "application/json; charset=utf-8",
        url: contextPath + "/preinscripcion/cancelar-inscripcion/" + idEduContinua,
        cache: !1,
        success: function (n) {
            toastr.success("Se ha cancelado la inscripción con éxito", "Excelente!");
            var i = document.getElementById("btn_inscripcion");
            (i.innerHTML = "INSCRÍBETE!"), i.setAttribute("onclick", "realizarInscripcion()"), hideSpinnerInscripcion(), loadCantidadInscritos();
        },
        error: function (n) {
            toastr.error(n.responseJSON.message, "Error!"), hideSpinnerInscripcion();
        },
    });
}
function clearCanvas() {
    canvasInscripcion.clear(), createTemplateCanvasInscripcion();
}
function loadCantidadInscritos() {
	if(path.includes('preinscripcion')){
		var n = contextPath + "/preinscripcion/reload/" + idAccesoEduContinua;
	    $("#div_info_educacionContinua").load(n);
	}
    
}

	function limpiarErrores() {
		try{
			var e = document.getElementById("inputConstanciaPago");
		    (document.getElementById("errorPerfilInscripcion").innerText = ""), e.classList.remove("is-invalid");
		    var a = document.getElementById("select_perfil_inscripcion");
		    (document.getElementById("errorConstanciaPagoInscripcion").innerText = ""), a.classList.remove("is-invalid");
		    document.getElementById("spanConstanciaPago").innerText = "Seleccionar un archivo…";
		}catch(err){
			
		}
	    
	}

$(document).ready(function () {
    createTemplateCanvasInscripcion();
    
    $("#modalPreinscripcion").on("show.bs.modal", function (e) {
    	$("#inputConstanciaPago").val(''), $("#select_perfil_inscripcion").val(0).trigger("change"), limpiarErrores();
    })
});
