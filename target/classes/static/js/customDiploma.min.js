fabric.Object.prototype.objectCaching=!0;var heightInicial,canvas=new fabric.Canvas("canvasDiploma",{renderOnAddRemove:!0,canvasOriginalWidth:800,canvasOriginalHeight:600,canvasWidth:800,canvasHeight:600});function loadImagen(){var e=document.getElementById("inputImagen").files[0];if(e){var t=new FileReader;t.onload=function(e){addImage(e.target.result)},t.readAsDataURL(e)}}function addImage(e){fabric.Image.fromURL(e,function(e){document.getElementById("cbxImagenFondo").checked?canvas.setBackgroundImage(e,canvas.renderAll.bind(canvas),{scaleX:canvas.width/e.width,scaleY:canvas.height/e.height}):(e.scale(.3),canvas.add(e)),resetValues()})}function loadText(){var e=document.getElementById("selectFontFamily").value,t=document.getElementById("inputTexto").value,a=document.getElementById("inputTamanio").value,n=document.getElementById("cbxTxtStroke").checked,i=document.getElementById("cbxTxtBold").checked?"bold":"normal",o=document.getElementById("cbxTxtUnderline").checked,c=document.getElementById("cbxTxtCursive").checked?"italic":"normal",r=document.getElementById("inputColor").value,d=document.getElementById("inputBorderColor").value;if(""!=t){var l=canvas.width/2;t.length>100&&(l=3*canvas.width/5),t=new fabric.Textbox(t,{fontSize:a,fontFamily:e,underline:o,linethrough:n,fontWeight:i,fontStyle:c,stroke:d,fill:r,textAlign:"center",width:l,fixedWith:l}),canvas.add(t),resetValues()}}function loadLine(){var e=document.getElementById("inputColorLine").value,t=new fabric.Line([250,125,400,125],{left:170,top:150,stroke:e});canvas.add(t),resetValues()}function dataURItoBlob(e){var t;t=e.split(",")[0].indexOf("base64")>=0?atob(e.split(",")[1]):unescape(e.split(",")[1]);for(var a=e.split(",")[0].split(":")[1].split(";")[0],n=new Uint8Array(t.length),i=0;i<t.length;i++)n[i]=t.charCodeAt(i);return new Blob([n],{type:a})}function loadDiplomaBase(){$.getJSON("../data/baseDiploma.json",function(e){e.objects.forEach(function(e){"textbox"==e.type&&(e=loadAttrEduContinua(e))}),canvas.loadFromJSON(e)})}function loadAttrEduContinua(e){heightInicial=e.height;var t=/%facultad%/gi;a=eduContinua.facultad.includes("Facultad")?eduContinua.facultad:"Facultad de "+eduContinua.facultad,e.text=e.text.replace(t,a),a=eduContinua.programaResp.includes("Programa")?eduContinua.programaResp:"Programa de "+eduContinua.programaResp,t=/%programa%/gi,e.text=e.text.replace(t,a),t=/%tipoEducacionContinua%/gi,e.text=e.text.replace(t,eduContinua.tipoEduContinua),t=/%educacionContinua%/gi,e.text=e.text.replace(t,eduContinua.nombre),t=/%intensidadHoraria%/gi;var a=numeroALetras(eduContinua.duracion)+" ("+eduContinua.duracion+") ";e.text=e.text.replace(t,a),t=/%fecha%/gi;var n=new Date(eduContinua.fechaFin);return a=n.getDate()+" de "+months[n.getMonth()]+" de "+n.getFullYear(),e.text=e.text.replace(t,a),fixSize(e),e}function fixSize(e){for(;e.width>e.fixedWidth;)e.set({fontSize:e.fontSize-1});for(;e.height>heightInicial;)e.set({fontSize:e.fontSize-1})}function loadSelectFontFamily(){$.getJSON("../data/font-family.json",function(e){fonts=e,fonts.families.forEach(function(e){var t=new Option(e,e,!1,!1);t.style.fontFamily="'"+e+"'",$("#selectFontFamily").append(t)})})}function resetValues(){document.getElementById("inputImagen").value="",document.getElementById("spnFile").innerText="Seleccionar un archivo…",document.getElementById("cbxImagenFondo").checked=!1,document.getElementById("inputTexto").value="",document.getElementById("cbxTxtStroke").checked=!1,document.getElementById("cbxTxtBold").checked=!1,document.getElementById("cbxTxtUnderline").checked=!1,document.getElementById("cbxTxtCursive").checked=!1,document.getElementById("inputColor").value="#000",document.getElementById("inputBorderColor").value="#000",document.getElementById("inputColorLine").value="#000"}$(document).ready(function(){loadSelectFontFamily(),ocultar("divNewImagen"),ocultar("divNewTexto"),ocultar("divNewLine"),ocultar("btnCargar"),$("html").keyup(function(e){if(46==e.keyCode||8==e.keyCode){var t=canvas.getActiveObject();if(!t)return"";if(t.isEditing)return;canvas.remove(t)}}),$("#btnCargar").on("click",function(e){switch($("#selectTipoElemento").val()){case"1":loadImagen();break;case"2":loadText();break;case"3":loadLine()}}),null!=diploma&&diploma.estructuraDiploma.objects.length>0?(canvas.loadFromJSON(diploma.estructuraDiploma)):loadDiplomaBase()}),canvas.on("mouse:dblclick",function(e){heightInicial=e.target.height}),canvas.on("text:changed",function(e){var t=e.target;for(t.width>t.fixedWidth&&(t.fontSize*=t.fixedWidth/(t.width+1),t.width=t.fixedWidth);t.height>heightInicial;)t.set({fontSize:t.fontSize-1})}),$("#selectTipoElemento").on("change",function(e){switch(e.preventDefault(),$("#selectTipoElemento").val()){case"1":mostrar("divNewImagen","inline"),mostrar("btnCargar","inline"),ocultar("divNewTexto"),ocultar("divNewLine");break;case"2":ocultar("divNewImagen"),mostrar("divNewTexto","inline"),mostrar("btnCargar","inline"),ocultar("divNewLine");break;case"3":ocultar("divNewImagen"),ocultar("divNewTexto"),mostrar("divNewLine","inline"),mostrar("btnCargar","inline")}}),$("#btnGuardarEstructuraCertificado").on("click",function(e){var t={};eduContinua.diploma?t.id=eduContinua.diploma.id:t.id=null,t.idEduContinua=eduContinua.id,t.estructuraDiploma=canvas,showSpinnerModal("btnGuardarEstructuraCertificado","btnSpinnerEstructuraCertificado"),$.ajax({headers:{"X-CSRF-TOKEN":token},type:"POST",contentType:"application/json; charset=utf-8",data:JSON.stringify(t),url:contextPath+"/educacion-continua/generar-estructura-diploma",cache:!1,success:function(e){t.id=e,eduContinua.diploma=t,loadDiplomaStructureParticipantes(JSON.stringify(t.estructuraDiploma)),toastr.success("Se ha guardado la estructura de la certificación exitosamente","Excelente!",{positionClass:"toast-top-right",preventDuplicates:!0}),hideSpinnerModal("btnGuardarEstructuraCertificado","btnSpinnerEstructuraCertificado"),refreshTableAsistentes()},error:function(e){hideSpinnerModal("btnGuardarEstructuraCertificado","btnSpinnerEstructuraCertificado")}})});